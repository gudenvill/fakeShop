<!DOCTYPE html>
<html lang="sv">

<head>
    <!-- Meta-taggar f√∂r dokumenttyp och responsiv design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Sidans titel som uppdateras dynamiskt med produktnamn -->
    <title id="page-title">FakeShop | Produktdetaljer</title>
    
    <!-- Externa CSS-bibliotek f√∂r ikoner (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Lokal CSS f√∂r grundl√§ggande styling av hela sidan -->
    <link rel="stylesheet" href="./css/styles.css">
    
    <!-- Specifik CSS f√∂r produktdetaljsidans styling -->
    <link rel="stylesheet" href="./css/productStyles.css">
</head>

<body>
    <!-- Huvudwrapper som omsluter hela sidans inneh√•ll -->
    <div class="wrapper">
        
        <!-- HEADER-SEKTION: Inneh√•ller logotyp och navigationsverktyg -->
        <header class="header">
            <!-- Logotypomr√•de med l√§nk tillbaka till startsidan -->
            <div class="logotype">
                <h1><a href="/" style="text-decoration: none; color: inherit;">logotype</a></h1>
            </div>
            
            <!-- Handlingsomr√•de med s√∂kf√§lt och knappar -->
            <div class="actions">
                <!-- S√∂kf√§lt f√∂r produkts√∂kning -->
                <div class="search-bar">
                    <input class="input" type="text" placeholder="S√∂k produkter...">
                    <button type="submit" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <!-- Handlingsknappar f√∂r √∂nskelista och varukorg -->
                <div class="action-buttons">
                    <a href="#" aria-label="Wishlist"> 
                        <i class="fas fa-heart"></i>
                    </a>
                    <a href="/basket.html" aria-label="Shopping Basket">
                        <i class="fas fa-shopping-basket"></i>
                    </a>
                </div>
            </div>
        </header>
        
        <!-- NAVIGATIONSSEKTION: Huvudnavigering med l√§nk hem -->
        <ul class="navigation-list">
            <li><a href="/" style="text-decoration: none; color: inherit;">Hem</a></li>
            <li>Nyheter</li>
            <li>B√§sts√§ljare</li>
            <li>Kvinnor</li>
            <li>M√§n</li>
        </ul>

        <!-- LADDNINGSTILLST√ÖND: Visas medan produktdata h√§mtas fr√•n servern -->
        <div id="loading" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Laddar produktinformation...</p>
        </div>

        <!-- FELTILLST√ÖND: Visas om produkten inte kan hittas eller vid serverfel -->
        <div id="error" class="error-container" style="display: none;">
            <div class="error-content">
                <i class="fas fa-exclamation-triangle error-icon"></i>
                <h2>Produkt hittades inte</h2>
                <p>Den beg√§rda produkten kunde inte hittas.</p>
                <a href="/" class="btn-primary">Tillbaka till startsidan</a>
            </div>
        </div>

        <!-- PRODUKTDETALJER: Huvudsektion som visar produktinformation -->
        <div id="product-content" class="product-details" style="display: none;">
            <!-- Produktbild-sektion -->
            <div class="product-details-image">
                <img id="product-image" src="./images/product.png" alt="Produktbild">
            </div>
            
            <!-- Produktinformation-sektion -->
            <div class="product-details-info">
                <!-- Produktnamn och m√§rke -->
                <div class="product-info-name">
                    <h3 id="product-name">Laddar...</h3>
                    <p id="product-brand">Laddar...</p>
                </div>
                
                <!-- Produktpris -->
                <div class="product-info-price" id="product-price">0 SEK</div>
                
                <!-- Lagerstatus -->
                <div class="product-stock-info">
                    <p id="product-stock" class="stock-status">Kontrollerar lagerstatus...</p>
                </div>
                
                <!-- Produktbeskrivning -->
                <p id="product-description" class="product-description">
                    Laddar produktbeskrivning...
                </p>
                
                <!-- L√§gg till varukorg-knapp -->
                <button class="add-to-cart-btn" id="add-to-cart">L√§gg i varukorg</button>
            </div>
        </div>

        <!-- RELATERADE PRODUKTER - LADDNINGSTILLST√ÖND -->
        <div id="related-loading" class="loading-container">
            <p>Laddar liknande produkter...</p>
        </div>

        <!-- RELATERADE PRODUKTER - KARUSELL MED SENASTE PRODUKTER -->
        <section id="related-products" class="related-products-carousel" style="display: none;">
            <h2>Senaste Produkter</h2>
            <div class="carousel-container">
                <div class="carousel-track">
                    <!-- Container d√§r relaterade produkter renderas dynamiskt -->
                    <div id="related-products-track">
                        <!-- Related products will be dynamically added here -->
                    </div>
                </div>
                
                <!-- Navigeringsknappar f√∂r karusell -->
                <button class="carousel-btn prev" aria-label="Previous related products">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-btn next" aria-label="Next related products">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- F√ñRDELAR-SEKTION: Visar butikens f√∂rdelar och tj√§nster -->
        <div class="perks-wrapper">
            <!-- F√∂rdel 1: Gratis frakt och returer -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-earth-americas"></i>
                </div>
                <div class="perk-text">
                    Gratis frakt och returer
                </div>
            </div>
            
            <!-- F√∂rdel 2: Expressfrakt -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-truck-fast"></i>
                </div>
                <div class="perk-text">
                    Expressfrakt
                </div>
            </div>
            
            <!-- F√∂rdel 3: S√§kra betalningar -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-shield"></i>
                </div>
                <div class="perk-text">
                    S√§kra betalningar
                </div>
            </div>
            
            <!-- F√∂rdel 4: Dagliga nyheter -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-face-smile"></i>
                </div>
                <div class="perk-text">
                    Nyheter varje dag
                </div>
            </div>
        </div>

        <!-- ACCORDION-SEKTION: Utf√§llbara menyer f√∂r additional navigation -->
        <div class="accordions">
            <!-- Accordion 1: Shopping-kategorier -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Shopping
                </button>
                <div class="panel">
                    <p class="panel-item">Vinterjackor</p>
                    <p class="panel-item">Pufferjackor</p>
                    <p class="panel-item">Koppa</p>
                    <p class="panel-item">Trenchcoats</p>
                </div>
            </div>

            <!-- Accordion 2: Mina sidor-funktioner -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Mina sidor
                </button>
                <div class="panel">
                    <p class="panel-item">Mina Ordrar</p>
                    <p class="panel-item">Mitt konto</p>
                </div>
            </div>

            <!-- Accordion 3: Kundtj√§nst-alternativ -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Kundtj√§nst
                </button>
                <div class="panel">
                    <p class="panel-item">Kontakta oss</p>
                    <p class="panel-item">Hitta hit</p>
                </div>
            </div>
        </div>

        <!-- FOOTER-SEKTION: Enkel copyright-information -->
        <footer>
            &#169; FakeShop
        </footer>
    </div>

    <!-- JAVASCRIPT-SEKTION: All funktionalitet f√∂r produktdetaljsidan -->
    <script>
        // ====================================================================
        // GLOBALA VARIABLER
        // ====================================================================
        
        // H√•ller aktuell produktdata efter h√§mtning fr√•n API
        let currentProduct = null;

        // ====================================================================
        // URL OCH PARAMETER-HANTERING
        // ====================================================================
        
        /**
         * H√§mta produkt-ID fr√•n URL:s query parameters
         * URL-format: /product-details.html?id=123
         * @returns {string|null} Produkt-ID eller null om inte finns
         */
        function getProductIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // ====================================================================
        // PRODUKTLOGIK: KONTROLLERA OM PRODUKT √ÑR NY
        // ====================================================================
        
        /**
         * Kontrollera om en produkt √§r ny (skapad inom 7 dagar)
         * Anv√§nds f√∂r att visa "Nyhet"-m√§rkning
         * @param {string} createdAt - Produktens skapandedatum fr√•n databasen
         * @returns {boolean} True om produkten √§r ny, annars false
         */
        function isNewProduct(createdAt) {
            const now = new Date();
            const productDate = new Date(createdAt);
            
            // Ber√§kna skillnad i dagar mellan nu och skapandedatum
            const daysDifference = Math.floor((now - productDate) / (1000 * 60 * 60 * 24));
            
            // Produkten √§r "ny" om den skapades inom 7 dagar
            return daysDifference <= 7;
        }

        // ====================================================================
        // API-KOMMUNIKATION: H√ÑMTA PRODUKTDATA
        // ====================================================================
        
        /**
         * H√§mta produktdata fr√•n API och visa p√• sidan
         * Hanterar laddningstillst√•nd, fel och framg√•ngsrik datah√§mtning
         */
        async function loadProduct() {
            // H√§mta produkt-ID fr√•n URL
            const productId = getProductIdFromUrl();
            
            // Om inget ID finns i URL, visa felmeddelande
            if (!productId) {
                showError();
                return;
            }

            try {
                console.log('üîÑ H√§mtar produkt med ID:', productId);
                
                // Skicka GET-request till produkter-API:et
                const response = await fetch(`/api/products/${productId}`);
                
                // Kontrollera att requestet var framg√•ngsrikt
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Parsea JSON-svaret
                const product = await response.json();
                console.log('‚úÖ Produkt h√§mtad:', product);
                
                // Spara produktdata globalt och visa p√• sidan
                currentProduct = product;
                displayProduct(product);
                
            } catch (error) {
                // Hantera fel vid h√§mtning
                console.error('‚ùå Fel vid h√§mtning av produkt:', error);
                showError();
            }
        }

        // ====================================================================
        // UI-TILLST√ÖNDSHANTERING: VISA/D√ñLJ OLIKA SEKTIONER
        // ====================================================================
        
        /**
         * Visa felmeddelande och d√∂lj andra sektioner
         * Anv√§nds n√§r produkten inte kan hittas eller vid API-fel
         */
        function showError() {
            // D√∂lj laddning och produktinneh√•ll
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-content').style.display = 'none';
            
            // Visa felmeddelande
            document.getElementById('error').style.display = 'block';
        }

        /**
         * Visa produktinneh√•ll och d√∂lj laddning/fel
         * Anv√§nds n√§r produktdata har h√§mtats framg√•ngsrikt
         */
        function showProduct() {
            // D√∂lj laddning och felmeddelande
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            // Visa produktinneh√•ll
            document.getElementById('product-content').style.display = 'flex';
        }

        // ====================================================================
        // PRODUKTVISNING: RENDERA PRODUKTDATA P√Ö SIDAN
        // ====================================================================
        
        /**
         * Visa produktinformation p√• sidan
         * Uppdaterar alla DOM-element med produktdata
         * @param {Object} product - Produktobjekt fr√•n API:et
         */
        function displayProduct(product) {
            // Uppdatera sidans titel med produktnamn
            document.getElementById('page-title').textContent = `FakeShop | ${product.name}`;
            
            // Uppdatera produktbild
            document.getElementById('product-image').src = product.image_url;
            document.getElementById('product-image').alt = product.name;
            
            // Uppdatera produktnamn och m√§rke
            document.getElementById('product-name').textContent = product.name;
            document.getElementById('product-brand').textContent = product.brand;
            
            // Uppdatera pris
            document.getElementById('product-price').textContent = `${product.price} SEK`;
            
            // Uppdatera produktbeskrivning
            document.getElementById('product-description').textContent = product.description || 'Ingen beskrivning tillg√§nglig.';
            
            // Uppdatera lagerstatus med f√§rgkodning
            const stockElement = document.getElementById('product-stock');
            if (product.stock_quantity > 0) {
                stockElement.textContent = `I lager (${product.stock_quantity} st)`;
                stockElement.className = 'stock-status in-stock';  // Gr√∂n f√§rg
            } else {
                stockElement.textContent = 'Slut i lager';
                stockElement.className = 'stock-status out-of-stock';  // R√∂d f√§rg
            }
            
            // Aktivera eller inaktivera "L√§gg till varukorg"-knappen baserat p√• lager
            const addToCartBtn = document.getElementById('add-to-cart');
            if (product.stock_quantity > 0) {
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = 'L√§gg i varukorg';
            } else {
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = 'Slut i lager';
            }
            
            // Visa produktsektionen
            showProduct();
        }

        // ====================================================================
        // VARUKORGSFUNKTIONALITET: L√ÑGG TILL PRODUKTER
        // ====================================================================
        
        /**
         * L√§gg till produkt i varukorg (localStorage)
         * Uppdaterar befintlig kvantitet eller l√§gger till ny produkt
         * @param {Object} product - Produktobjekt att l√§gga till
         */
        function addToBasket(product) {
            // H√§mta befintlig varukorg fr√•n localStorage
            let basket = JSON.parse(localStorage.getItem('fakeShopBasket')) || [];
            
            // Kontrollera om produkten redan finns i varukorgen
            const existingItem = basket.find(item => item.id === product.id);
            
            if (existingItem) {
                // Om produkten finns, √∂ka kvantiteten
                existingItem.quantity += 1;
                console.log('‚úÖ √ñkade kvantitet f√∂r:', product.name);
            } else {
                // Om produkten inte finns, l√§gg till den med kvantitet 1
                basket.push({
                    id: product.id,
                    name: product.name,
                    brand: product.brand,
                    price: product.price,
                    image_url: product.image_url,
                    quantity: 1
                });
                console.log('‚úÖ Lade till ny produkt:', product.name);
            }
            
            // Spara uppdaterad varukorg i localStorage
            localStorage.setItem('fakeShopBasket', JSON.stringify(basket));
            
            // Visa bekr√§ftelse till anv√§ndaren
            showAddToCartFeedback();
        }

        /**
         * Visa visuell bekr√§ftelse n√§r produkt l√§ggs till i varukorg
         * √Ñndrar knapptext tillf√§lligt f√∂r att bekr√§fta √•tg√§rden
         */
        function showAddToCartFeedback() {
            const button = document.getElementById('add-to-cart');
            const originalText = button.textContent;
            
            // √Ñndra knapptext och style tillf√§lligt
            button.textContent = 'Tillagd! ‚úì';
            button.style.backgroundColor = '#28a745';  // Gr√∂n f√§rg
            button.disabled = true;
            
            // √Öterst√§ll knappen efter 2 sekunder
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';  // √Öterg√• till original styling
                button.disabled = false;
            }, 2000);
        }

        // ====================================================================
        // RELATERADE PRODUKTER: H√ÑMTA OCH VISA SENASTE PRODUKTER
        // ====================================================================
        
        /**
         * H√§mta och visa relaterade produkter (senaste produkter)
         * Visar en karusell med andra produkter fr√•n butiken
         */
        async function loadRelatedProducts() {
            try {
                console.log('üîÑ H√§mtar relaterade produkter...');
                
                // H√§mta alla produkter fr√•n API:et
                const response = await fetch('/api/products');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const allProducts = await response.json();
                
                // Filtrera bort den aktuella produkten och ta de 8 senaste
                const relatedProducts = allProducts
                    .filter(product => product.id !== currentProduct?.id)
                    .slice(0, 8);
                
                console.log('‚úÖ H√§mtade', relatedProducts.length, 'relaterade produkter');
                
                // Rendera relaterade produkter
                displayRelatedProducts(relatedProducts);
                
            } catch (error) {
                console.error('‚ùå Fel vid h√§mtning av relaterade produkter:', error);
                
                // D√∂lj relaterade produkter-sektionen vid fel
                document.getElementById('related-loading').style.display = 'none';
            }
        }

        /**
         * Visa relaterade produkter i karusell
         * @param {Array} products - Array med produktobjekt att visa
         */
        function displayRelatedProducts(products) {
            const track = document.getElementById('related-products-track');
            
            // Skapa HTML f√∂r alla relaterade produkter
            track.innerHTML = products.map(product => {
                // Kontrollera om produkten √§r ny f√∂r "Nyhet"-m√§rkning
                const isNew = isNewProduct(product.created_at);
                
                return `
                    <div class="related-product-card" data-product-id="${product.id}">
                        <div class="related-product-image">
                            <img src="${product.image_url}" alt="${product.name}">
                            ${isNew ? '<div class="product-overlay overlay-banner">Nyhet</div>' : ''}
                        </div>
                        <div class="related-product-info">
                            <h4>${product.name}</h4>
                            <p>${product.brand}</p>
                            <span class="related-product-price">${product.price} SEK</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // D√∂lj laddning och visa relaterade produkter
            document.getElementById('related-loading').style.display = 'none';
            document.getElementById('related-products').style.display = 'block';
        }

        // ====================================================================
        // KARUSELL-FUNKTIONALITET: NAVIGERING MELLAN RELATERADE PRODUKTER
        // ====================================================================
        
        /**
         * Initiera karusell-navigation f√∂r relaterade produkter
         * L√§gger till klick-lyssnare f√∂r fram√•t/bak√•t-knappar
         */
        function initializeCarousel() {
            const track = document.getElementById('related-products-track');
            const prevBtn = document.querySelector('.carousel-btn.prev');
            const nextBtn = document.querySelector('.carousel-btn.next');
            
            let currentIndex = 0;  // H√•ller koll p√• aktuell position
            const cardWidth = 250; // Bredd per produktkort (inkl. margin)
            const visibleCards = 4; // Antal synliga kort √•t g√•ngen
            
            /**
             * Uppdatera karusellens position
             * @param {number} index - Ny position att visa
             */
            function updateCarousel(index) {
                const maxIndex = Math.max(0, track.children.length - visibleCards);
                currentIndex = Math.max(0, Math.min(index, maxIndex));
                
                // Flytta karusellen med CSS transform
                track.style.transform = `translateX(-${currentIndex * cardWidth}px)`;
                
                // Uppdatera knapp-tillg√§nglighet
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex >= maxIndex;
            }
            
            // Event listeners f√∂r navigeringsknappar
            prevBtn.addEventListener('click', () => {
                updateCarousel(currentIndex - 1);
            });
            
            nextBtn.addEventListener('click', () => {
                updateCarousel(currentIndex + 1);
            });
            
            // Initiera karusellen
            updateCarousel(0);
        }

        // ====================================================================
        // EVENT LISTENERS: HUVUDFUNKTIONALITET
        // ====================================================================
        
        /**
         * Initiera alla event listeners f√∂r sidan
         * Accordion, s√∂k, varukorg och produktklick
         */
        function initializeEventListeners() {
            // ================================================================
            // ACCORDION-FUNKTIONALITET
            // ================================================================
            
            const accordions = document.getElementsByClassName("accordion");
            for (let i = 0; i < accordions.length; i++) {
                accordions[i].addEventListener("click", function () {
                    // V√§xla active-klass och panel-synlighet
                    this.classList.toggle("active");
                    const panel = this.nextElementSibling;
                    
                    if (panel.style.display === "block") {
                        panel.style.display = "none";
                    } else {
                        panel.style.display = "block";
                    }
                });
            }
            
            // ================================================================
            // L√ÑGG TILL VARUKORG-FUNKTIONALITET
            // ================================================================
            
            document.getElementById('add-to-cart').addEventListener('click', function() {
                if (currentProduct && currentProduct.stock_quantity > 0) {
                    addToBasket(currentProduct);
                }
            });
            
            // ================================================================
            // PRODUKTKORT-NAVIGATION (RELATERADE PRODUKTER)
            // ================================================================
            
            // Event delegation f√∂r dynamiskt skapade produktkort
            document.addEventListener('click', function(e) {
                const productCard = e.target.closest('.related-product-card');
                if (productCard) {
                    const productId = productCard.dataset.productId;
                    // Navigera till produktdetaljsida f√∂r den klickade produkten
                    window.location.href = `/product-details.html?id=${productId}`;
                }
            });
        }

        // ====================================================================
        // HUVUDINITIALISERING: STARTA ALLT N√ÑR DOM:EN √ÑR LADDAD
        // ====================================================================
        
        /**
         * DOMContentLoaded event listener som initialiserar hela sidan
         * K√∂r alla huvudfunktioner n√§r DOM:en √§r f√§rdigladdad
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ Produktdetaljsida laddad, initialiserar...');
            
            // Initiera event listeners
            initializeEventListeners();
            
            // Ladda produktdata
            loadProduct();
            
            // Ladda relaterade produkter (efter en kort f√∂rdr√∂jning)
            setTimeout(loadRelatedProducts, 500);
            
            // Initiera karusell n√§r relaterade produkter √§r laddade
            setTimeout(initializeCarousel, 1000);
        });
    </script>
</body>

</html>