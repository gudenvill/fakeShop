<!DOCTYPE html>
<html lang="sv">
<head>
  <!-- Meta-taggar f√∂r dokumenttyp och spr√•k -->
  <meta charset="UTF-8">
  
  <!-- Sidans titel som visas i webbl√§sarens flik -->
  <title>Administration: Lista ordrar</title>
  
  <!-- CSS f√∂r admin-gr√§nssnittet -->
  <link rel="stylesheet" href="../../css/adminStyles.css">
</head>
<body>
  <!-- HUVUDCONTAINER F√ñR ADMIN-GR√ÑNSSNITTET -->
  <div class="admin-container">
    
    <!-- SIDEBAR: Navigeringsmeny f√∂r admin-funktioner -->
    <aside class="sidebar">
      <h2>Administration</h2>
      <!-- Navigeringsmeny f√∂r olika admin-sektioner -->
      <nav>
        <ul>
          <!-- L√§nk till produkthantering -->
          <li><a href="/admin/products/index.html">Produkter</a></li>
          <!-- Aktuell sida markerad med strong -->
          <li><strong>Ordrar</strong></li>
        </ul>
      </nav>
    </aside>
    
    <!-- HUVUDINNEH√ÖLL: Orderhantering och statistik -->
    <main class="main-content">
      
      <!-- ADMIN-HEADER: Rubrik och statistikkort -->
      <div class="admin-header">
        <h1>Ordrar</h1>
        
        <!-- STATISTIKSEKTION: Visar viktiga KPI:er f√∂r orderhantering -->
        <div class="admin-stats">
          <!-- Statistikkort 1: Totalt antal ordrar -->
          <div class="stat-card">
            <span class="stat-number" id="total-orders">0</span>
            <span class="stat-label">Totalt ordrar</span>
          </div>
          
          <!-- Statistikkort 2: Antal slutf√∂rda ordrar -->
          <div class="stat-card">
            <span class="stat-number" id="completed-orders">0</span>
            <span class="stat-label">Slutf√∂rda</span>
          </div>
          
          <!-- Statistikkort 3: Antal v√§ntande ordrar -->
          <div class="stat-card">
            <span class="stat-number" id="pending-orders">0</span>
            <span class="stat-label">V√§ntande</span>
          </div>
          
          <!-- Statistikkort 4: Total oms√§ttning fr√•n slutf√∂rda ordrar -->
          <div class="stat-card">
            <span class="stat-number" id="total-revenue">0 SEK</span>
            <span class="stat-label">Total oms√§ttning</span>
          </div>
        </div>
      </div>
      
      <!-- LADDNINGSTILLST√ÖND: Visas medan ordrar h√§mtas fr√•n API:et -->
      <div id="loading" class="loading-message">
        Laddar ordrar...
      </div>
      
      <!-- ORDERSLISTA: Huvudinneh√•llet n√§r ordrar har laddats -->
      <div id="orders-content" style="display: none;">
        <div class="table-container">
          <!-- Tabell f√∂r att visa alla ordrar -->
          <table class="admin-table">
            <!-- Tabellhuvud med kolumnrubriker -->
            <thead>
              <tr>
                <th>Ordernummer</th>     <!-- Unikt ordernummer -->
                <th>Kund</th>            <!-- Kundens namn -->
                <th>E-post</th>          <!-- Kundens e-postadress -->
                <th>Produkter</th>       <!-- Sammanfattning av best√§llda produkter -->
                <th>Totalt</th>          <!-- Orderns totala v√§rde -->
                <th>Status</th>          <!-- Orderstatus (v√§ntande, slutf√∂rd, etc.) -->
                <th>Skapad</th>          <!-- N√§r ordern skapades -->
                <th>√Ötg√§rder</th>        <!-- Knappar f√∂r hantering -->
              </tr>
            </thead>
            
            <!-- Tabellkropp som fylls dynamiskt av JavaScript -->
            <tbody id="orders-table-body">
              <!-- Ordrar laddas h√§r dynamiskt -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- TOM LISTA MEDDELANDE: Visas n√§r inga ordrar finns -->
      <div id="empty-orders" class="empty-message" style="display: none;">
        <h3>Inga ordrar hittades</h3>
        <p>Det finns inga ordrar att visa √§nnu.</p>
      </div>
    </main>
  </div>

  <!-- ORDER DETALJER MODAL: Popup f√∂r att visa detaljerad orderinformation -->
  <div id="order-modal" class="modal" style="display: none;">
    <div class="modal-content">
      
      <!-- Modal-header med titel och st√§ng-knapp -->
      <div class="modal-header">
        <h2 id="modal-title">Orderdetaljer</h2>
        <span class="close" onclick="closeOrderModal()">&times;</span>
      </div>
      
      <!-- Modal-kropp d√§r orderdetaljer visas -->
      <div class="modal-body" id="modal-body">
        <!-- Order detaljer laddas h√§r dynamiskt -->
      </div>
      
      <!-- Modal-footer med st√§ng-knapp -->
      <div class="modal-footer">
        <button class="btn secondary" onclick="closeOrderModal()">St√§ng</button>
      </div>
    </div>
  </div>

  <!-- JAVASCRIPT-SEKTION: All funktionalitet f√∂r orderhantering -->
  <script>
    // ====================================================================
    // GLOBALA VARIABLER: DATAH√ÖLLNING F√ñR ORDERHANTERING
    // ====================================================================
    
    // Array som h√•ller alla ordrar fr√•n API:et
    let allOrders = [];

    // ====================================================================
    // API-KOMMUNIKATION: H√ÑMTA ORDRAR FR√ÖN SERVERN
    // ====================================================================
    
    /**
     * H√§mta alla ordrar fr√•n API:et och visa dem
     * Hanterar API-kommunikation, felhantering och UI-uppdatering
     */
    async function fetchOrders() {
      try {
        console.log('üîÑ H√§mtar ordrar fr√•n API...');
        
        // Skicka GET-request till ordrar-API:et
        const response = await fetch('/api/orders');
        
        // Kontrollera att requestet var framg√•ngsrikt
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parsea JSON-svaret fr√•n servern
        const orders = await response.json();
        console.log('‚úÖ Ordrar h√§mtade:', orders.length);
        
        // Spara ordrar globalt och uppdatera UI
        allOrders = orders;
        displayOrders(orders);
        updateStats(orders);
        
      } catch (error) {
        // Hantera fel vid API-kommunikation
        console.error('‚ùå Fel vid h√§mtning av ordrar:', error);
        document.getElementById('loading').textContent = 'Fel vid laddning av ordrar.';
      }
    }

    // ====================================================================
    // UI-RENDERING: VISA ORDRAR I TABELLEN
    // ====================================================================
    
    /**
     * Visa ordrar i admin-tabellen
     * Skapar HTML f√∂r varje order och hanterar tom lista
     * @param {Array} orders - Array med orderobjekt fr√•n API:et
     */
    function displayOrders(orders) {
      console.log('üé® Renderar ordertabell med', orders.length, 'ordrar');
      
      // H√§mta referenser till DOM-element
      const tableBody = document.getElementById('orders-table-body');
      const loading = document.getElementById('loading');
      const content = document.getElementById('orders-content');
      const empty = document.getElementById('empty-orders');
      
      // ================================================================
      // HANTERA TOM ORDERLISTA
      // ================================================================
      
      if (orders.length === 0) {
        loading.style.display = 'none';
        empty.style.display = 'block';
        return;
      }
      
      // ================================================================
      // SKAPA HTML F√ñR VARJE ORDER
      // ================================================================
      
      const ordersHTML = orders.map(order => {
        // F√• CSS-klass och text f√∂r orderstatus
        const statusClass = getStatusClass(order.status);
        const statusText = getStatusText(order.status);
        
        // Formatera skapandedatum f√∂r visning
        const createdDate = new Date(order.created_at).toLocaleDateString('sv-SE', {
          year: 'numeric',    // √Örtal med fyra siffror
          month: 'short',     // M√•nad f√∂rkortad (jan, feb, etc.)
          day: 'numeric',     // Dag utan nolla f√∂re
          hour: '2-digit',    // Timme med tv√• siffror
          minute: '2-digit'   // Minut med tv√• siffror
        });
        
        // Skapa HTML f√∂r denna orderrad
        return `
          <tr>
            <!-- Ordernummer med betoning -->
            <td>
              <strong>${order.order_number}</strong>
            </td>
            
            <!-- Kundens namn -->
            <td>${order.customer_name}</td>
            
            <!-- Kundens e-postadress -->
            <td>${order.customer_email}</td>
            
            <!-- Produktsammanfattning -->
            <td>
              <small>${order.items_summary || 'Inga produkter'}</small>
            </td>
            
            <!-- Ordertotal med betoning -->
            <td><strong>${order.total_amount} SEK</strong></td>
            
            <!-- Status med f√§rgkodad badge -->
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            
            <!-- Formaterat skapandedatum -->
            <td>
              <small>${createdDate}</small>
            </td>
            
            <!-- √Ötg√§rdsknappar och status-dropdown -->
            <td>
              <div class="action-buttons">
                <!-- Knapp f√∂r att visa orderdetaljer -->
                <button class="btn small primary" onclick="viewOrder(${order.id})" title="Visa detaljer">
                  üëÅÔ∏è
                </button>
                
                <!-- Dropdown f√∂r att √§ndra orderstatus -->
                <select class="status-select" onchange="updateOrderStatus(${order.id}, this.value)">
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>V√§ntande</option>
                  <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Slutf√∂rd</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Skickad</option>
                  <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Avbruten</option>
                </select>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      // ================================================================
      // UPPDATERA UI MED ORDERDATA
      // ================================================================
      
      // S√§tt in genererad HTML i tabellkroppen
      tableBody.innerHTML = ordersHTML;
      
      // D√∂lj laddning och visa inneh√•llet
      loading.style.display = 'none';
      content.style.display = 'block';
      
      console.log('‚úÖ Ordrar visade i tabell');
    }

    // ====================================================================
    // STATISTIKBER√ÑKNINGAR: UPPDATERA KPI-KORT
    // ====================================================================
    
    /**
     * Uppdatera statistikkorten baserat p√• orderdata
     * Ber√§knar totaler, status-f√∂rdelning och oms√§ttning
     * @param {Array} orders - Array med orderobjekt
     */
    function updateStats(orders) {
      console.log('üìä Ber√§knar statistik f√∂r', orders.length, 'ordrar');
      
      // ================================================================
      // BER√ÑKNA GRUNDL√ÑGGANDE STATISTIK
      // ================================================================
      
      // Totalt antal ordrar
      const totalOrders = orders.length;
      
      // Antal slutf√∂rda ordrar
      const completedOrders = orders.filter(o => o.status === 'completed').length;
      
      // Antal v√§ntande ordrar
      const pendingOrders = orders.filter(o => o.status === 'pending').length;
      
      // Total oms√§ttning fr√•n slutf√∂rda ordrar
      const totalRevenue = orders
        .filter(o => o.status === 'completed')  // Endast slutf√∂rda ordrar
        .reduce((sum, o) => sum + parseFloat(o.total_amount), 0);  // Summera totalbelopp
      
      // ================================================================
      // UPPDATERA UI MED BER√ÑKNAD STATISTIK
      // ================================================================
      
      document.getElementById('total-orders').textContent = totalOrders;
      document.getElementById('completed-orders').textContent = completedOrders;
      document.getElementById('pending-orders').textContent = pendingOrders;
      document.getElementById('total-revenue').textContent = `${totalRevenue.toFixed(2)} SEK`;
      
      console.log('‚úÖ Statistik uppdaterad:', {
        total: totalOrders,
        completed: completedOrders,
        pending: pendingOrders,
        revenue: totalRevenue
      });
    }

    // ====================================================================
    // STATUSHANTERING: CSS-KLASSER OCH SVENSKA √ñVERS√ÑTTNINGAR
    // ====================================================================
    
    /**
     * F√• CSS-klass f√∂r orderstatus
     * Anv√§nds f√∂r att f√§rgkoda status-badges
     * @param {string} status - Orderstatus fr√•n databasen
     * @returns {string} CSS-klassnamn f√∂r styling
     */
    function getStatusClass(status) {
      switch(status) {
        case 'completed': return 'status-completed';  // Gr√∂n f√∂r slutf√∂rd
        case 'pending': return 'status-pending';      // Gul f√∂r v√§ntande
        case 'shipped': return 'status-shipped';      // Bl√• f√∂r skickad
        case 'cancelled': return 'status-cancelled';  // R√∂d f√∂r avbruten
        default: return 'status-pending';             // Standard √§r v√§ntande
      }
    }

    /**
     * F√• svenska √∂vers√§ttning av orderstatus
     * Konverterar engelska API-statusar till svenska f√∂r anv√§ndaren
     * @param {string} status - Orderstatus fr√•n databasen
     * @returns {string} Status p√• svenska
     */
    function getStatusText(status) {
      switch(status) {
        case 'completed': return 'Slutf√∂rd';
        case 'pending': return 'V√§ntande';
        case 'shipped': return 'Skickad';
        case 'cancelled': return 'Avbruten';
        default: return 'Ok√§nd';
      }
    }

    // ====================================================================
    // ORDERDETALJER: VISA FULLST√ÑNDIG ORDERINFORMATION
    // ====================================================================
    
    /**
     * Visa detaljerad orderinformation i modal
     * H√§mtar utf√∂rlig orderdata fr√•n API:et och visar i popup
     * @param {number} orderId - ID f√∂r ordern att visa
     */
    async function viewOrder(orderId) {
      try {
        console.log('üîÑ H√§mtar orderdetaljer f√∂r ID:', orderId);
        
        // Skicka GET-request f√∂r specifik order
        const response = await fetch(`/api/orders/${orderId}`);
        
        // Kontrollera att requestet var framg√•ngsrikt
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parsea JSON-svaret med detaljerad orderdata
        const order = await response.json();
        console.log('‚úÖ Orderdetaljer h√§mtade:', order);
        
        // Visa orderdata i modal
        showOrderModal(order);
        
      } catch (error) {
        // Hantera fel vid h√§mtning av orderdetaljer
        console.error('‚ùå Fel vid h√§mtning av orderdetaljer:', error);
        alert('Kunde inte ladda orderdetaljer.');
      }
    }

    // ====================================================================
    // MODAL-HANTERING: VISA OCH D√ñLJ ORDERDETALJER
    // ====================================================================
    
    /**
     * Visa orderdetaljer i modal-popup
     * Skapar detaljerad HTML f√∂r all orderinformation
     * @param {Object} order - Komplett orderobjekt med produkter och kundinfo
     */
    function showOrderModal(order) {
      console.log('üìã Visar orderdetaljer i modal f√∂r order:', order.order_number);
      
      // H√§mta referenser till modal-element
      const modal = document.getElementById('order-modal');
      const title = document.getElementById('modal-title');
      const body = document.getElementById('modal-body');
      
      // S√§tt modal-titel med ordernummer
      title.textContent = `Order ${order.order_number}`;
      
      // ================================================================
      // SKAPA HTML F√ñR PRODUKTLISTA
      // ================================================================
      
      // Skapa tabell f√∂r best√§llda produkter
      const itemsHTML = order.items && order.items.length > 0 
        ? order.items.map(item => `
            <tr>
              <td>${item.product_name}</td>      <!-- Produktnamn -->
              <td>${item.product_brand}</td>     <!-- Produktm√§rke -->
              <td>${item.price} SEK</td>         <!-- Pris per styck -->
              <td>${item.quantity}</td>          <!-- Antal best√§llda -->
              <td>${item.subtotal} SEK</td>      <!-- Delsumma f√∂r produkten -->
            </tr>
          `).join('')
        : '<tr><td colspan="5">Inga produkter hittades</td></tr>';
      
      // ================================================================
      // SKAPA FULLST√ÑNDIG MODAL-INNEH√ÖLL
      // ================================================================
      
      body.innerHTML = `
        <div class="order-details">
          
          <!-- SEKTION 1: Kundinformation -->
          <div class="detail-section">
            <h3>Kundinformation</h3>
            <p><strong>Namn:</strong> ${order.customer_name}</p>
            <p><strong>E-post:</strong> ${order.customer_email}</p>
            <p><strong>Telefon:</strong> ${order.customer_phone || 'Ej angivet'}</p>
          </div>
          
          <!-- SEKTION 2: Leveransadress -->
          <div class="detail-section">
            <h3>Leveransadress</h3>
            <p>${order.shipping_address}</p>
          </div>
          
          <!-- SEKTION 3: Best√§llda produkter i tabellformat -->
          <div class="detail-section">
            <h3>Best√§llda produkter</h3>
            <table class="modal-table">
              <thead>
                <tr>
                  <th>Produkt</th>
                  <th>M√§rke</th>
                  <th>Pris</th>
                  <th>Antal</th>
                  <th>Summa</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHTML}
              </tbody>
            </table>
          </div>
          
          <!-- SEKTION 4: Orderinformation och totaler -->
          <div class="detail-section">
            <h3>Orderinformation</h3>
            <p><strong>Status:</strong> ${getStatusText(order.status)}</p>
            <p><strong>Betalmetod:</strong> ${order.payment_method || 'Ej angivet'}</p>
            <p><strong>Totalt:</strong> ${order.total_amount} SEK</p>
            <p><strong>Skapad:</strong> ${new Date(order.created_at).toLocaleString('sv-SE')}</p>
          </div>
        </div>
      `;
      
      // Visa modal genom att s√§tta display till block
      modal.style.display = 'block';
      
      console.log('‚úÖ Modal visad med orderdetaljer');
    }

    /**
     * St√§ng orderdetaljer-modal
     * D√∂ljer modal-popup och √•terst√§ller tillst√•nd
     */
    function closeOrderModal() {
      console.log('‚ùå St√§nger orderdetaljer-modal');
      document.getElementById('order-modal').style.display = 'none';
    }

    // ====================================================================
    // STATUSUPPDATERING: √ÑNDRA ORDERSTATUS VIA API
    // ====================================================================
    
    /**
     * Uppdatera orderstatus via API
     * Skickar PUT-request f√∂r att √§ndra status och uppdaterar UI
     * @param {number} orderId - ID f√∂r ordern att uppdatera
     * @param {string} newStatus - Ny status att s√§tta
     */
    async function updateOrderStatus(orderId, newStatus) {
      try {
        console.log('üîÑ Uppdaterar order status:', orderId, 'till', newStatus);
        
        // Skicka PUT-request till status-endpoint
        const response = await fetch(`/api/orders/${orderId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });
        
        // Kontrollera att requestet var framg√•ngsrikt
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parsea svaret fr√•n servern
        const result = await response.json();
        console.log('‚úÖ Order status uppdaterad:', result);
        
        // Ladda om orderlistan f√∂r att visa uppdaterad data
        fetchOrders();
        
      } catch (error) {
        // Hantera fel vid statusuppdatering
        console.error('‚ùå Fel vid uppdatering av order status:', error);
        alert('Kunde inte uppdatera order status.');
        
        // Ladda om f√∂r att √•terst√§ll select-v√§rdet
        fetchOrders();
      }
    }

    // ====================================================================
    // EVENT HANDLING: MODAL-INTERAKTION OCH KLICKH√ÑNDELSER
    // ====================================================================
    
    /**
     * St√§ng modal vid klick utanf√∂r modal-inneh√•llet
     * Global event listener f√∂r att f√∂rb√§ttra anv√§ndarupplevelsen
     */
    window.onclick = function(event) {
      const modal = document.getElementById('order-modal');
      
      // Om anv√§ndaren klickar p√• modal-bakgrunden (ej inneh√•llet)
      if (event.target === modal) {
        closeOrderModal();
      }
    }

    // ====================================================================
    // HUVUDINITIALISERING: STARTA ALLT N√ÑR DOM:EN √ÑR LADDAD
    // ====================================================================
    
    /**
     * DOMContentLoaded event listener som initialiserar admin-sidan
     * Startar h√§mtning av ordrar n√§r allt √§r redo
     */
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ Admin ordersida laddad, h√§mtar ordrar...');
      
      // Starta h√§mtning av orderdata fr√•n API:et
      fetchOrders();
    });
  </script>
</body>
</html> 