<!DOCTYPE html>
<html lang="sv">
<head>
  <!-- Meta-taggar f√∂r dokumenttyp och spr√•k -->
  <meta charset="UTF-8">
  
  <!-- Sidans titel som visas i webbl√§sarens flik -->
  <title>Administration: Lista produkter</title>
  
  <!-- CSS f√∂r admin-gr√§nssnittet -->
  <link rel="stylesheet" href="../../css/adminStyles.css">
</head>
<body>
  <!-- HUVUDCONTAINER F√ñR ADMIN-GR√ÑNSSNITTET -->
  <div class="admin-container">
    
    <!-- SIDEBAR: Navigeringsmeny f√∂r admin-funktioner -->
    <aside class="sidebar">
      <h2>Administration</h2>
      <!-- Navigeringsmeny f√∂r olika admin-sektioner -->
      <nav>
        <ul>
          <!-- Aktuell sida markerad med strong -->
          <li><strong>Produkter</strong></li>
        </ul>
      </nav>
    </aside>
    
    <!-- HUVUDINNEH√ÖLL: Produktlista och hantering -->
    <main class="main-content">
      <h1>Produkter</h1>
      
      <!-- KNAPP F√ñR ATT SKAPA NY PRODUKT -->
      <a href="/admin/products/new.html" class="button">Ny produkt</a>
      
      <!-- LADDNINGSTILLST√ÖND: Visas medan produkter h√§mtas -->
      <div id="loading" style="text-align: center; padding: 20px;">
        Laddar produkter...
      </div>
      
      <!-- PRODUKTTABELL: Visar alla produkter i tabellformat -->
      <table id="products-table" style="display: none;">
        <!-- Tabellhuvud med kolumnrubriker -->
        <thead>
          <tr>
            <th>ID</th>           <!-- Unikt produkt-ID -->
            <th>Namn</th>         <!-- Produktnamn -->
            <th>M√§rke</th>        <!-- Produktm√§rke -->
            <th>SKU</th>          <!-- Artikelnummer -->
            <th>Pris</th>         <!-- Produktpris -->
            <th>Lager</th>        <!-- Lagersaldo -->
            <th>Skapad</th>       <!-- Skapandedatum -->
            <th>Status</th>       <!-- Ny/vanlig status -->
            <th>√Ötg√§rder</th>     <!-- Redigera/ta bort knappar -->
          </tr>
        </thead>
        
        <!-- Tabellkropp som fylls dynamiskt av JavaScript -->
        <tbody id="products-tbody">
          <!-- Produkter laddas dynamiskt h√§r -->
        </tbody>
      </table>
      
      <!-- FELMEDDELANDE: Visas vid problem med att ladda produkter -->
      <div id="error-message" style="display: none; color: red; text-align: center; padding: 20px;">
        Fel vid laddning av produkter. F√∂rs√∂k uppdatera sidan.
      </div>
    </main>
  </div>

  <!-- JAVASCRIPT-SEKTION: All funktionalitet f√∂r produktlista -->
  <script>
    // ====================================================================
    // DATUMFORMATERING: VISA DATUM I L√ÑSBART FORMAT
    // ====================================================================
    
    /**
     * Formatera datum f√∂r visning med relativ tid
     * @param {string} dateString - ISO-datum fr√•n databasen
     * @returns {string} Formaterat datum med relativ information
     */
    function formatDate(dateString) {
      // Skapa Date-objekt fr√•n ISO-str√§ng
      const date = new Date(dateString);
      const now = new Date();
      
      // Ber√§kna antal dagar sedan produkten skapades
      const daysDifference = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      // Formatera datum till svenskt format
      const formattedDate = date.toLocaleDateString('sv-SE', {
        year: 'numeric',        // √Örtal med fyra siffror
        month: 'short',         // M√•nad f√∂rkortad (jan, feb, etc.)
        day: 'numeric'          // Dag utan nolla f√∂re
      });
      
      // L√§gg till relativ tid baserat p√• antal dagar
      if (daysDifference === 0) {
        return `${formattedDate} (Idag)`;
      } else if (daysDifference === 1) {
        return `${formattedDate} (Ig√•r)`;
      } else if (daysDifference <= 7) {
        return `${formattedDate} (${daysDifference} dagar sedan)`;
      } else {
        return `${formattedDate} (${daysDifference} dagar sedan)`;
      }
    }

    // ====================================================================
    // PRODUKTSTATUS: KONTROLLERA OM PRODUKT √ÑR NY
    // ====================================================================
    
    /**
     * Kontrollera om en produkt √§r ny f√∂r status-kolumn
     * Produkter som skapats inom 7 dagar markeras som "Nyhet"
     * @param {string} createdAt - Produktens skapandedatum
     * @returns {string} HTML-str√§ng med status-m√§rkning
     */
    function getProductStatus(createdAt) {
      const now = new Date();
      const productDate = new Date(createdAt);
      
      // Ber√§kna antal dagar sedan produkten skapades
      const daysDifference = Math.floor((now - productDate) / (1000 * 60 * 60 * 24));
      
      // Returnera l√§mplig status baserat p√• √•lder
      if (daysDifference <= 7) {
        return '<span style="color: green; font-weight: bold;">‚ú® Nyhet</span>';
      } else {
        return '<span style="color: gray;">Vanlig</span>';
      }
    }

    // ====================================================================
    // API-KOMMUNIKATION: H√ÑMTA PRODUKTER FR√ÖN SERVERN
    // ====================================================================
    
    /**
     * H√§mta alla produkter fr√•n API:et och visa dem
     * Hanterar laddningstillst√•nd, fel och framg√•ngsrik datah√§mtning
     */
    async function loadProducts() {
      try {
        console.log('üîÑ H√§mtar produkter f√∂r admin...');
        
        // Skicka GET-request till produkter-API:et
        const response = await fetch('/api/products');
        
        // Kontrollera att requestet var framg√•ngsrikt
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parsea JSON-svaret
        const products = await response.json();
        console.log('‚úÖ Produkter h√§mtade:', products.length);
        
        // Visa produkterna i tabellen
        displayProducts(products);
        
      } catch (error) {
        // Hantera fel vid h√§mtning
        console.error('‚ùå Fel vid h√§mtning av produkter:', error);
        
        // D√∂lj laddning och visa felmeddelande
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // ====================================================================
    // UI-RENDERING: VISA PRODUKTER I TABELLEN
    // ====================================================================
    
    /**
     * Visa produkter i tabellen
     * Sorterar produkter och genererar HTML f√∂r varje rad
     * @param {Array} products - Array med produktobjekt fr√•n API:et
     */
    function displayProducts(products) {
      console.log('üé® Renderar produkttabell med', products.length, 'produkter');
      
      // H√§mta referenser till DOM-element
      const tbody = document.getElementById('products-tbody');
      const loading = document.getElementById('loading');
      const table = document.getElementById('products-table');
      
      // ================================================================
      // HANTERA TOM PRODUKTLISTA
      // ================================================================
      
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Inga produkter hittades</td></tr>';
      } else {
        // ============================================================
        // SORTERA OCH RENDERA PRODUKTER
        // ============================================================
        
        // Sortera produkter efter skapandedatum (nyaste f√∂rst)
        const sortedProducts = products.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // Skapa HTML f√∂r varje produktrad
        tbody.innerHTML = sortedProducts.map(product => `
          <tr>
            <!-- Produkt-ID -->
            <td>${product.id}</td>
            
            <!-- Produktnamn -->
            <td>${product.name}</td>
            
            <!-- Produktm√§rke -->
            <td>${product.brand}</td>
            
            <!-- SKU (artikelnummer) -->
            <td>${product.sku}</td>
            
            <!-- Pris med valuta -->
            <td>${product.price} SEK</td>
            
            <!-- Lagersaldo -->
            <td>${product.stock_quantity}</td>
            
            <!-- Formaterat skapandedatum -->
            <td>${formatDate(product.created_at)}</td>
            
            <!-- Status (ny/vanlig) -->
            <td>${getProductStatus(product.created_at)}</td>
            
            <!-- √Ötg√§rdsknappar (redigera/ta bort) -->
            <td>
              <button onclick="editProduct(${product.id})" class="icon edit" title="Redigera">‚úèÔ∏è</button>
              <button onclick="deleteProduct(${product.id}, '${product.name}')" class="icon delete" title="Ta bort">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      }
      
      // ================================================================
      // VISA TABELL OCH D√ñLJ LADDNING
      // ================================================================
      
      loading.style.display = 'none';
      table.style.display = 'table';
      
      console.log('‚úÖ Produkttabell renderad');
    }

    // ====================================================================
    // CRUD-OPERATIONER: REDIGERA OCH TA BORT PRODUKTER
    // ====================================================================
    
    /**
     * Redigera produkt - navigera till edit-sidan
     * @param {number} id - ID f√∂r produkten att redigera
     */
    function editProduct(id) {
      console.log('‚úèÔ∏è Navigerar till redigering av produkt ID:', id);
      window.location.href = `/admin/products/edit.html?id=${id}`;
    }

    /**
     * Ta bort produkt med bekr√§ftelse
     * @param {number} id - ID f√∂r produkten att ta bort
     * @param {string} name - Produktnamn f√∂r bekr√§ftelse
     */
    async function deleteProduct(id, name) {
      console.log('üóëÔ∏è Beg√§ran om borttagning av produkt:', name, 'ID:', id);
      
      // ================================================================
      // BEKR√ÑFTELSE FR√ÖN ANV√ÑNDAREN
      // ================================================================
      
      // Visa bekr√§ftelsedialog
      if (!confirm(`√Ñr du s√§ker p√• att du vill ta bort "${name}"?`)) {
        console.log('‚ùå Anv√§ndaren avbr√∂t borttagningen');
        return;
      }
      
      try {
        console.log('üóëÔ∏è Tar bort produkt:', id);
        
        // Skicka DELETE-request till API:et
        const response = await fetch(`/api/products/${id}`, {
          method: 'DELETE'
        });
        
        // Kontrollera att requestet var framg√•ngsrikt
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parsea svaret
        const result = await response.json();
        console.log('‚úÖ Produkt borttagen:', result.message);
        
        // ============================================================
        // UPPDATERA PRODUKTLISTAN
        // ============================================================
        
        // Ladda om produktlistan f√∂r att visa uppdaterad data
        loadProducts();
        
      } catch (error) {
        // Hantera fel vid borttagning
        console.error('‚ùå Fel vid borttagning:', error);
        alert('Fel vid borttagning av produkt. F√∂rs√∂k igen.');
      }
    }

    // ====================================================================
    // HUVUDINITIALISERING: STARTA ALLT N√ÑR DOM:EN √ÑR LADDAD
    // ====================================================================
    
    /**
     * DOMContentLoaded event listener som initialiserar sidan
     * Startar produktladdning n√§r allt √§r redo
     */
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ Admin produktlista laddad, h√§mtar produkter...');
      
      // Starta produktladdning
      loadProducts();
    });
  </script>
</body>
</html>
