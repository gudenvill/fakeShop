<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Administration: Lista produkter</title>
  <link rel="stylesheet" href="../../css/adminStyles.css">
</head>
<body>
  <div class="admin-container">
    <aside class="sidebar">
      <h2>Administration</h2>
      <nav>
        <ul>
          <li><strong>Produkter</strong></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <h1>Produkter</h1>
      <a href="/admin/products/new.html" class="button">Ny produkt</a>
      
      <div id="loading" style="text-align: center; padding: 20px;">
        Laddar produkter...
      </div>
      
      <table id="products-table" style="display: none;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Namn</th>
            <th>M√§rke</th>
            <th>SKU</th>
            <th>Pris</th>
            <th>Lager</th>
            <th>Skapad</th>
            <th>Status</th>
            <th>√Ötg√§rder</th>
          </tr>
        </thead>
        <tbody id="products-tbody">
          <!-- Produkter laddas dynamiskt h√§r -->
        </tbody>
      </table>
      
      <div id="error-message" style="display: none; color: red; text-align: center; padding: 20px;">
        Fel vid laddning av produkter. F√∂rs√∂k uppdatera sidan.
      </div>
    </main>
  </div>

  <script>
    // Formatera datum f√∂r visning
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const daysDifference = Math.floor((now - date) / (1000 * 60 * 60 * 24));
      
      const formattedDate = date.toLocaleDateString('sv-SE', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      
      if (daysDifference === 0) {
        return `${formattedDate} (Idag)`;
      } else if (daysDifference === 1) {
        return `${formattedDate} (Ig√•r)`;
      } else if (daysDifference <= 7) {
        return `${formattedDate} (${daysDifference} dagar sedan)`;
      } else {
        return `${formattedDate} (${daysDifference} dagar sedan)`;
      }
    }

    // Kontrollera om produkt √§r ny f√∂r status-kolumn
    function getProductStatus(createdAt) {
      const now = new Date();
      const productDate = new Date(createdAt);
      const daysDifference = Math.floor((now - productDate) / (1000 * 60 * 60 * 24));
      
      if (daysDifference <= 7) {
        return '<span style="color: green; font-weight: bold;">‚ú® Nyhet</span>';
      } else {
        return '<span style="color: gray;">Vanlig</span>';
      }
    }

    // H√§mta och visa alla produkter
    async function loadProducts() {
      try {
        console.log('üîÑ H√§mtar produkter f√∂r admin...');
        const response = await fetch('/api/products');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const products = await response.json();
        console.log('‚úÖ Produkter h√§mtade:', products.length);
        
        displayProducts(products);
      } catch (error) {
        console.error('‚ùå Fel vid h√§mtning av produkter:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = 'block';
      }
    }

    // Visa produkter i tabellen
    function displayProducts(products) {
      const tbody = document.getElementById('products-tbody');
      const loading = document.getElementById('loading');
      const table = document.getElementById('products-table');
      
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">Inga produkter hittades</td></tr>';
      } else {
        // Sortera produkter efter skapandedatum (nyaste f√∂rst)
        const sortedProducts = products.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        tbody.innerHTML = sortedProducts.map(product => `
          <tr>
            <td>${product.id}</td>
            <td>${product.name}</td>
            <td>${product.brand}</td>
            <td>${product.sku}</td>
            <td>${product.price} SEK</td>
            <td>${product.stock_quantity}</td>
            <td>${formatDate(product.created_at)}</td>
            <td>${getProductStatus(product.created_at)}</td>
            <td>
              <button onclick="editProduct(${product.id})" class="icon edit" title="Redigera">‚úèÔ∏è</button>
              <button onclick="deleteProduct(${product.id}, '${product.name}')" class="icon delete" title="Ta bort">üóëÔ∏è</button>
            </td>
          </tr>
        `).join('');
      }
      
      loading.style.display = 'none';
      table.style.display = 'table';
    }

    // Redigera produkt - navigera till edit-sidan
    function editProduct(id) {
      window.location.href = `/admin/products/edit.html?id=${id}`;
    }

    // Ta bort produkt
    async function deleteProduct(id, name) {
      if (!confirm(`√Ñr du s√§ker p√• att du vill ta bort "${name}"?`)) {
        return;
      }
      
      try {
        console.log('üóëÔ∏è Tar bort produkt:', id);
        const response = await fetch(`/api/products/${id}`, {
          method: 'DELETE'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('‚úÖ Produkt borttagen:', result.message);
        
        // Ladda om produktlistan
        loadProducts();
        
      } catch (error) {
        console.error('‚ùå Fel vid borttagning:', error);
        alert('Fel vid borttagning av produkt. F√∂rs√∂k igen.');
      }
    }

    // Ladda produkter n√§r sidan laddas
    document.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>
