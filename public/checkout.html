<!DOCTYPE html>
<html lang="sv">

<head>
    <!-- Meta-taggar f√∂r dokumenttyp och responsiv design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Sidans titel som visas i webbl√§sarens flik -->
    <title>FakeShop | Kassa</title>
    
    <!-- Externa CSS-bibliotek f√∂r ikoner (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Lokal CSS f√∂r grundl√§ggande styling av hela sidan -->
    <link rel="stylesheet" href="./css/styles.css">
    
    <!-- Specifik CSS f√∂r kassasidans styling -->
    <link rel="stylesheet" href="./css/checkoutStyles.css">
</head>

<body>
    <!-- Huvudwrapper som omsluter hela sidans inneh√•ll -->
    <div class="wrapper">
        
        <!-- HEADER-SEKTION: Inneh√•ller logotyp och navigationsverktyg -->
        <header class="header">
            <!-- Logotypomr√•de -->
            <div class="logotype">
                <h1>logotype</h1>
            </div>
            
            <!-- Handlingsomr√•de med s√∂kf√§lt och knappar -->
            <div class="actions">
                <!-- S√∂kf√§lt f√∂r produkts√∂kning -->
                <div class="search-bar">
                    <input class="input" type="text" placeholder="Search products...">
                    <button type="submit" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <!-- Handlingsknappar f√∂r √∂nskelista och varukorg -->
                <div class="action-buttons">
                    <button aria-label="Wishlist">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button aria-label="Shopping Basket">
                        <i class="fas fa-shopping-basket"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- NAVIGATIONSSEKTION: Huvudnavigering f√∂r olika produktkategorier -->
        <ul class="navigation-list">
            <li>Nyheter</li>
            <li>B√§sts√§ljare</li>
            <li>Kvinnor</li>
            <li>M√§n</li>
        </ul>

        <!-- HUVUDINNEH√ÖLL: Kassasidans huvudomr√•de -->
        <main class="checkout-page-main">
            <!-- Sidans huvudrubrik -->
            <h1>Kassan</h1>

            <!-- Kassans inneh√•llsomr√•de med tv√• huvudsektioner -->
            <div class="checkout-content">
                
                <!-- SEKTION 1: Varukorgssummering -->
                <section class="checkout-summary">
                    <h2>Varukorg</h2>
                    
                    <!-- Tabell som visar alla produkter i varukorgen -->
                    <table class="cart-summary-table">
                        <!-- Tabellhuvud med kolumnrubriker -->
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Antal</th>
                                <th>Pris</th>
                                <th>Totalt</th>
                            </tr>
                        </thead>
                        
                        <!-- Tabellkropp d√§r produkterna renderas dynamiskt av JavaScript -->
                        <tbody>
                            <!-- Exempel p√• statisk produkt (kommer ers√§ttas av JavaScript) -->
                            <tr>
                                <td data-label="Produkt:">Svart T-Shirt<br><small>Artikelnummer: 12345</small></td>
                                <td data-label="Antal:">1</td>
                                <td data-label="Pris:">199 SEK</td>
                                <td data-label="Totalt:">199 SEK</td>
                            </tr>
                            
                            <!-- Ytterligare exempel p√• statisk produkt -->
                             <tr>
                                <td data-label="Produkt:">Vit T-Shirt<br><small>Artikelnummer: 67890</small></td>
                                <td data-label="Antal:">2</td>
                                <td data-label="Pris:">199 SEK</td>
                                <td data-label="Totalt:">398 SEK</td>
                            </tr>
                        </tbody>
                        
                        <!-- Tabellfot med summeringar (delsumma, frakt, totalt) -->
                        <tfoot>
                            <tr>
                                <td colspan="3">RE-SUMMA</td>
                                <td>597 SEK</td>
                            </tr>
                        </tfoot>
                    </table>
                </section>

                <!-- SEKTION 2: Kunduppgifter och best√§llningsformul√§r -->
                <section class="customer-details">
                    <h2>Kunduppgifter</h2>
                    
                    <!-- Formul√§r f√∂r kundinformation och best√§llning -->
                    <form class="customer-form" id="checkout-form">
                        
                        <!-- F√∂rnamn - obligatoriskt f√§lt -->
                        <div class="form-group">
                            <label for="fnamn">F√∂rnamn</label>
                            <input type="text" id="fnamn" name="fnamn" required>
                        </div>
                        
                        <!-- Efternamn - obligatoriskt f√§lt -->
                        <div class="form-group">
                            <label for="enamn">Efternamn</label>
                            <input type="text" id="enamn" name="enamn" required>
                        </div>
                        
                        <!-- E-post - obligatoriskt f√§lt med e-postvalidering -->
                         <div class="form-group full-width">
                            <label for="email">E-post</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <!-- Telefonnummer - valfritt f√§lt -->
                        <div class="form-group full-width">
                             <label for="telefon">Telefon (valfritt)</label>
                             <input type="tel" id="telefon" name="telefon" placeholder="070-123 45 67">
                        </div>
                        
                        <!-- Leveransadress - grupperade f√§lt f√∂r fullst√§ndig adress -->
                        <div class="form-group full-width">
                             <label for="adress">Leveransadress</label>
                             <!-- Gata och gatunummer -->
                             <input type="text" id="gata" name="gata" placeholder="Gata och nummer" required>
                             <!-- Postnummer -->
                             <input type="text" id="postnummer" name="postnummer" placeholder="Postnummer" required>
                             <!-- Stad -->
                             <input type="text" id="stad" name="stad" placeholder="Stad" required>
                         </div>

                        <!-- Kryssruta f√∂r nyhetsbrevsprenumeration -->
                        <div class="form-group checkbox-group full-width">
                            <input type="checkbox" id="newsletter" name="newsletter" value="subscribe">
                            <label for="newsletter">Jag vill ta emot nyhetsbrev</label>
                        </div>

                        <!-- Skicka-knapp f√∂r att slutf√∂ra k√∂pet -->
                        <div class="form-group full-width">
                            <button type="submit" class="btn-purchase" id="purchase-btn">
                                <!-- Normal text som visas n√§r knappen √§r aktiv -->
                                <span id="btn-text">Slutf√∂r k√∂p</span>
                                <!-- Laddningsanimation som visas under bearbetning -->
                                <span id="btn-spinner" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> Bearbetar...
                                </span>
                            </button>
                        </div>
                    </form>
                </section>
            </div>
        </main>

        <!-- F√ñRDELAR-SEKTION: Visar butikens f√∂rdelar och tj√§nster -->
        <div class="perks-wrapper">
            <!-- F√∂rdel 1: Gratis frakt och returer -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-earth-americas"></i>
                </div>
                <div class="perk-text">
                    Gratis frakt och returer
                </div>
            </div>
            
            <!-- F√∂rdel 2: Expressfrakt -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-truck-fast"></i>
                </div>
                <div class="perk-text">
                    Expressfrakt
                </div>
            </div>
            
            <!-- F√∂rdel 3: S√§kra betalningar -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-shield"></i>
                </div>
                <div class="perk-text">
                    S√§kra betalningar
                </div>
            </div>
            
            <!-- F√∂rdel 4: Dagliga nyheter -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-face-smile"></i>
                </div>
                <div class="perk-text">
                    Nyheter varje dag
                </div>
            </div>
        </div>

        <!-- ACCORDION-SEKTION: Utf√§llbara menyer f√∂r mobil navigation -->
        <div class="accordions">
             <!-- Accordion 1: Shopping-kategorier -->
             <div class="accordion-wrapper">
                <button class="accordion">
                    Shopping
                </button>
                <div class="panel">
                    <p class="panel-item">Vinterjackor</p>
                    <p class="panel-item">Pufferjackor</p>
                    <p class="panel-item">Koppa</p>
                    <p class="panel-item">Trenchcoats</p>
                </div>
            </div>

            <!-- Accordion 2: Mina sidor-funktioner -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Mina sidor
                </button>
                <div class="panel">
                    <p class="panel-item">Mina Ordrar</p>
                    <p class="panel-item">Mitt konto</p>
                </div>
            </div>

            <!-- Accordion 3: Kundtj√§nst-alternativ -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Kundtj√§nst
                </button>
                <div class="panel">
                    <p class="panel-item">Kontakta oss</p>
                    <p class="panel-item">Hitta hit</p>
                </div>
            </div>
        </div>

        <!-- FOOTER-SEKTION: Enkel copyright-information -->
        <footer>
            &#169; FakeShop
        </footer>
    </div>
    
    <!-- JAVASCRIPT-SEKTION: All funktionalitet f√∂r kassasidan -->
     <script>
        // ====================================================================
        // ACCORDION-FUNKTIONALITET F√ñR MOBIL NAVIGATION
        // ====================================================================
        
        // H√§mta alla accordion-knappar fr√•n DOM:en
        var acc = document.getElementsByClassName("accordion");
        var i;

        // Loopa igenom alla accordion-knappar och l√§gg till click-lyssnare
        for (i = 0; i < acc.length; i++) {
             // Kontrollera om sk√§rmen √§r mindre √§n 640px (mobil)
             if (window.matchMedia("(max-width: 639px)").matches) {
                 // L√§gg till click-lyssnare f√∂r varje accordion-knapp
                 acc[i].addEventListener("click", function () {
                    // V√§xla "active"-klassen p√• den klickade knappen
                    this.classList.toggle("active");
                    
                    // Hitta n√§sta element (panelen som h√∂r till knappen)
                    var panel = this.nextElementSibling;
                    
                    // V√§xla synlighet f√∂r panelen
                    if (panel.style.display === "block") {
                        panel.style.display = "none";  // D√∂lj panelen
                    } else {
                        panel.style.display = "block"; // Visa panelen
                    }
                });
            }
        }

        // ====================================================================
        // CHECKOUT-MANAGER KLASS: Hanterar hela kassafunktionaliteten
        // ====================================================================
        
        class CheckoutManager {
            /**
             * Konstruktor som initialiserar CheckoutManager
             * Laddar varukorgen fr√•n localStorage och startar initialiseringen
             */
            constructor() {
                // Ladda befintliga varukorgsartiklar fr√•n localStorage
                this.basketItems = this.loadBasket();
                console.log('üõí CheckoutManager initialiserad, varukorg:', this.basketItems);
                
                // Starta initialiseringsprocessen
                this.init();
            }

            /**
             * Ladda varukorg fr√•n localStorage
             * @returns {Array} Array med varukorgsartiklar, tom array om inget finns
             */
            loadBasket() {
                // F√∂rs√∂k h√§mta varukorg fr√•n localStorage
                const basket = localStorage.getItem('fakeShopBasket');
                
                // Om varukorg finns, parsea JSON-data, annars returnera tom array
                return basket ? JSON.parse(basket) : [];
            }

            /**
             * R√§kna ut alla totaler f√∂r best√§llningen
             * @returns {Object} Objekt med subtotal, shipping och total
             */
            calculateTotals() {
                // R√§kna ut delsumma genom att summera pris √ó antal f√∂r alla artiklar
                const subtotal = this.basketItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Ber√§kna fraktkostnad: Gratis √∂ver 500 SEK, 49 SEK annars (0 om tom korg)
                const shipping = subtotal > 500 ? 0 : (subtotal > 0 ? 49 : 0);
                
                // Ber√§kna totalsumma
                const total = subtotal + shipping;
                
                // Returnera alla ber√§knade v√§rden
                return { subtotal, shipping, total };
            }

            /**
             * Rendera varukorgssummeringen i checkout-tabellen
             * Uppdaterar b√•de artiklar och totaler
             */
            renderCheckoutSummary() {
                // H√§mta referenser till tabellens body och foot
                const tableBody = document.querySelector('.cart-summary-table tbody');
                const tableFoot = document.querySelector('.cart-summary-table tfoot');

                // Kontrollera om varukorgen √§r tom
                if (this.basketItems.length === 0) {
                    // Visa meddelande om tom varukorg
                    tableBody.innerHTML = '<tr><td colspan="4">Din varukorg √§r tom</td></tr>';
                    tableFoot.innerHTML = '<tr><td colspan="3">TOTALT</td><td>0 SEK</td></tr>';
                    return; // Avsluta funktionen tidigt
                }

                // Rendera alla artiklar som tabellrader
                tableBody.innerHTML = this.basketItems.map(item => `
                    <tr>
                        <td data-label="Produkt:">${item.name}<br><small>${item.brand}</small></td>
                        <td data-label="Antal:">${item.quantity}</td>
                        <td data-label="Pris:">${item.price} SEK</td>
                        <td data-label="Totalt:">${item.price * item.quantity} SEK</td>
                    </tr>
                `).join('');

                // Ber√§kna och visa totaler
                const { subtotal, shipping, total } = this.calculateTotals();
                tableFoot.innerHTML = `
                    <tr>
                        <td colspan="3">Delsumma</td>
                        <td>${subtotal} SEK</td>
                    </tr>
                    <tr>
                        <td colspan="3">Frakt</td>
                        <td>${shipping === 0 ? 'Gratis' : shipping + ' SEK'}</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td colspan="3">TOTALT</td>
                        <td>${total} SEK</td>
                    </tr>
                `;
            }

            /**
             * Hantera formul√§rinl√§mning f√∂r checkout-processen
             * @param {Event} event - Form submit event
             */
            async handleCheckout(event) {
                console.log('üì® Form submission f√•ngad av JavaScript');
                
                // VIKTIGT: F√∂rhindra webbl√§sarens standard form submission
                event.preventDefault();
                event.stopPropagation();
                
                // Kontrollera att varukorgen inte √§r tom
                if (this.basketItems.length === 0) {
                    alert('Din varukorg √§r tom!');
                    return;
                }

                // H√§mta formul√§rdata
                const form = event.target;
                const formData = new FormData(form);
                
                // H√§mta referenser till UI-element f√∂r loading state
                const btnText = document.getElementById('btn-text');
                const btnSpinner = document.getElementById('btn-spinner');
                const submitBtn = document.getElementById('purchase-btn');
                
                // Visa loading state: d√∂lj text, visa spinner, inaktivera knapp
                btnText.style.display = 'none';
                btnSpinner.style.display = 'inline';
                submitBtn.disabled = true; // F√∂rhindra flera klick
                
                try {
                    // Skapa orderdata-objekt fr√•n formul√§rdata och varukorgsartiklar
                    const orderData = {
                        // Kombinera f√∂r- och efternamn till fullst√§ndigt namn
                        customer_name: `${formData.get('fnamn')} ${formData.get('enamn')}`,
                        customer_email: formData.get('email'),
                        // Telefon √§r valfritt, anv√§nd tom str√§ng om inte ifyllt
                        customer_phone: formData.get('telefon') || '',
                        // Kombinera alla adressf√§lt till en fullst√§ndig adress
                        shipping_address: `${formData.get('gata')}, ${formData.get('postnummer')} ${formData.get('stad')}`,
                        payment_method: 'card', // Standardbetalningsmetod
                        // Mappa varukorgsartiklar till orderformat
                        items: this.basketItems.map(item => ({
                            id: item.id,
                            name: item.name,
                            brand: item.brand,
                            quantity: item.quantity,
                            price: item.price
                        }))
                    };

                    // Logga orderdata f√∂r debugging
                    console.log('üîÑ Skickar order:', orderData);
                    console.log('üìä Items detaljer:', JSON.stringify(orderData.items, null, 2));

                    // Skicka POST-request till API:et f√∂r att skapa ordern
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(orderData)
                    });

                    // Kontrollera om API-svaret √§r framg√•ngsrikt
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Parsea JSON-svaret fr√•n API:et
                    const result = await response.json();
                    console.log('‚úÖ Order skapad:', result);

                    // Rensa varukorgen fr√•n localStorage eftersom ordern √§r skapad
                    localStorage.removeItem('fakeShopBasket');

                    // Omdirigera anv√§ndaren till bekr√§ftelsesidan med order-ID
                    window.location.href = `/order-confirmation.html?order=${result.order_id}`;

                } catch (error) {
                    // Hantera fel som kan uppst√• under checkout-processen
                    console.error('‚ùå Fel vid checkout:', error);
                    alert('Ett fel uppstod vid best√§llningen. F√∂rs√∂k igen.');
                    
                    // √Öterst√§ll knappens tillst√•nd s√• anv√§ndaren kan f√∂rs√∂ka igen
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                    submitBtn.disabled = false;
                }
            }

            /**
             * Initiera CheckoutManager genom att rendera UI och l√§gga till event listeners
             */
            init() {
                console.log('üîß Initialiserar CheckoutManager...');
                
                // Rendera den aktuella varukorgens inneh√•ll
                this.renderCheckoutSummary();
                
                // Hitta checkout-formul√§ret och l√§gg till submit-lyssnare
                const form = document.getElementById('checkout-form');
                if (form) {
                    console.log('‚úÖ Form hittad, l√§gger till event listener');
                    // Binda handleCheckout-metoden till form submit event
                    form.addEventListener('submit', (e) => this.handleCheckout(e));
                    
                    // Extra s√§kerhet - lyssna √§ven p√• submit-knappen direkt
                    const submitBtn = document.getElementById('purchase-btn');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', (e) => {
                            console.log('üñ±Ô∏è Submit-knapp klickad');
                            // L√•t den normala form submission hantera detta
                        });
                    }
                } else {
                    // Fels√∂kning: logga om formul√§ret inte hittas
                    console.error('‚ùå Kunde inte hitta checkout-form!');
                }
            }
        }

        // ====================================================================
        // HUVUDINITIALISERING: Startar allt n√§r DOM:en √§r laddad
        // ====================================================================
        
        // V√§nta tills hela DOM:en √§r laddad innan vi startar JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM laddad, startar CheckoutManager');
            
            // ================================================================
            // UTVECKLINGS-/FELS√ñKNINGSSEKTION: Rensa och l√§gg till testdata
            // ================================================================
            
            console.log('üßπ Rensar befintlig varukorg f√∂r fels√∂kning...');
            // Rensa befintlig varukorg f√∂r konsistent testning
            localStorage.removeItem('fakeShopBasket');
            
            console.log('üõí L√§gger till nya testprodukter...');
            // Skapa testartiklar f√∂r att demonstrera funktionaliteten
            const testItems = [
                {
                    id: 36,                              // Unikt produkt-ID
                    name: "Premium Kappa",               // Produktnamn
                    brand: "Calvin Klein",               // M√§rke
                    price: 1299,                         // Pris i SEK
                    quantity: 1,                         // Antal i varukorgen
                    image_url: "/images/product.png"     // Produktbild (anv√§nds inte i checkout)
                },
                {
                    id: 5,                               // Unikt produkt-ID f√∂r andra produkten
                    name: "Hot Tr√∂ja",                   // Produktnamn
                    brand: "Tommy Hilfiger",             // M√§rke
                    price: 549,                          // Pris i SEK
                    quantity: 2,                         // Antal i varukorgen
                    image_url: "/images/product.png"     // Produktbild
                }
            ];
            
            // Spara testartiklarna i localStorage
            localStorage.setItem('fakeShopBasket', JSON.stringify(testItems));
            console.log('‚úÖ Testprodukter tillagda:', testItems);
            
            // Skapa och starta CheckoutManager med testdata
            new CheckoutManager();
        });
    </script>
</body>
</html>