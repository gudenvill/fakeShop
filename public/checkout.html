<!DOCTYPE html>
<html lang="sv">

<head>
    <!-- Meta-taggar för dokumenttyp och responsiv design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Sidans titel som visas i webbläsarens flik -->
    <title>FakeShop | Kassa</title>
    
    <!-- Externa CSS-bibliotek för ikoner (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Lokal CSS för grundläggande styling av hela sidan -->
    <link rel="stylesheet" href="./css/styles.css">
    
    <!-- Specifik CSS för kassasidans styling -->
    <link rel="stylesheet" href="./css/checkoutStyles.css">
</head>

<body>
    <!-- Huvudwrapper som omsluter hela sidans innehåll -->
    <div class="wrapper">
        
        <!-- HEADER-SEKTION: Innehåller logotyp och navigationsverktyg -->
        <header class="header">
            <!-- Logotypområde -->
            <div class="logotype">
                <h1>logotype</h1>
            </div>
            
            <!-- Handlingsområde med sökfält och knappar -->
            <div class="actions">
                <!-- Sökfält för produktsökning -->
                <div class="search-bar">
                    <input class="input" type="text" placeholder="Search products...">
                    <button type="submit" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <!-- Handlingsknappar för önskelista och varukorg -->
                <div class="action-buttons">
                    <button aria-label="Wishlist">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button aria-label="Shopping Basket">
                        <i class="fas fa-shopping-basket"></i>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- NAVIGATIONSSEKTION: Huvudnavigering för olika produktkategorier -->
        <ul class="navigation-list">
            <li>Nyheter</li>
            <li>Bästsäljare</li>
            <li>Kvinnor</li>
            <li>Män</li>
        </ul>

        <!-- HUVUDINNEHÅLL: Kassasidans huvudområde -->
        <main class="checkout-page-main">
            <!-- Sidans huvudrubrik -->
            <h1>Kassan</h1>

            <!-- Kassans innehållsområde med två huvudsektioner -->
            <div class="checkout-content">
                
                <!-- SEKTION 1: Varukorgssummering -->
                <section class="checkout-summary">
                    <h2>Varukorg</h2>
                    
                    <!-- Tabell som visar alla produkter i varukorgen -->
                    <table class="cart-summary-table">
                        <!-- Tabellhuvud med kolumnrubriker -->
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Antal</th>
                                <th>Pris</th>
                                <th>Totalt</th>
                            </tr>
                        </thead>
                        
                        <!-- Tabellkropp där produkterna renderas dynamiskt av JavaScript -->
                        <tbody>
                            <!-- Exempel på statisk produkt (kommer ersättas av JavaScript) -->
                            <tr>
                                <td data-label="Produkt:">Svart T-Shirt<br><small>Artikelnummer: 12345</small></td>
                                <td data-label="Antal:">1</td>
                                <td data-label="Pris:">199 SEK</td>
                                <td data-label="Totalt:">199 SEK</td>
                            </tr>
                            
                            <!-- Ytterligare exempel på statisk produkt -->
                             <tr>
                                <td data-label="Produkt:">Vit T-Shirt<br><small>Artikelnummer: 67890</small></td>
                                <td data-label="Antal:">2</td>
                                <td data-label="Pris:">199 SEK</td>
                                <td data-label="Totalt:">398 SEK</td>
                            </tr>
                        </tbody>
                        
                        <!-- Tabellfot med summeringar (delsumma, frakt, totalt) -->
                        <tfoot>
                            <tr>
                                <td colspan="3">RE-SUMMA</td>
                                <td>597 SEK</td>
                            </tr>
                        </tfoot>
                    </table>
                </section>

                <!-- SEKTION 2: Kunduppgifter och beställningsformulär -->
                <section class="customer-details">
                    <h2>Kunduppgifter</h2>
                    
                    <!-- Formulär för kundinformation och beställning -->
                    <form class="customer-form" id="checkout-form">
                        
                        <!-- Förnamn - obligatoriskt fält -->
                        <div class="form-group">
                            <label for="fnamn">Förnamn</label>
                            <input type="text" id="fnamn" name="fnamn" required>
                        </div>
                        
                        <!-- Efternamn - obligatoriskt fält -->
                        <div class="form-group">
                            <label for="enamn">Efternamn</label>
                            <input type="text" id="enamn" name="enamn" required>
                        </div>
                        
                        <!-- E-post - obligatoriskt fält med e-postvalidering -->
                         <div class="form-group full-width">
                            <label for="email">E-post</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <!-- Telefonnummer - valfritt fält -->
                        <div class="form-group full-width">
                             <label for="telefon">Telefon (valfritt)</label>
                             <input type="tel" id="telefon" name="telefon" placeholder="070-123 45 67">
                        </div>
                        
                        <!-- Leveransadress - grupperade fält för fullständig adress -->
                        <div class="form-group full-width">
                             <label for="adress">Leveransadress</label>
                             <!-- Gata och gatunummer -->
                             <input type="text" id="gata" name="gata" placeholder="Gata och nummer" required>
                             <!-- Postnummer -->
                             <input type="text" id="postnummer" name="postnummer" placeholder="Postnummer" required>
                             <!-- Stad -->
                             <input type="text" id="stad" name="stad" placeholder="Stad" required>
                         </div>

                        <!-- Kryssruta för nyhetsbrevsprenumeration -->
                        <div class="form-group checkbox-group full-width">
                            <input type="checkbox" id="newsletter" name="newsletter" value="subscribe">
                            <label for="newsletter">Jag vill ta emot nyhetsbrev</label>
                        </div>

                        <!-- Skicka-knapp för att slutföra köpet -->
                        <div class="form-group full-width">
                            <button type="submit" class="btn-purchase" id="purchase-btn">
                                <!-- Normal text som visas när knappen är aktiv -->
                                <span id="btn-text">Slutför köp</span>
                                <!-- Laddningsanimation som visas under bearbetning -->
                                <span id="btn-spinner" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i> Bearbetar...
                                </span>
                            </button>
                        </div>
                    </form>
                </section>
            </div>
        </main>

        <!-- FÖRDELAR-SEKTION: Visar butikens fördelar och tjänster -->
        <div class="perks-wrapper">
            <!-- Fördel 1: Gratis frakt och returer -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-earth-americas"></i>
                </div>
                <div class="perk-text">
                    Gratis frakt och returer
                </div>
            </div>
            
            <!-- Fördel 2: Expressfrakt -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-truck-fast"></i>
                </div>
                <div class="perk-text">
                    Expressfrakt
                </div>
            </div>
            
            <!-- Fördel 3: Säkra betalningar -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-shield"></i>
                </div>
                <div class="perk-text">
                    Säkra betalningar
                </div>
            </div>
            
            <!-- Fördel 4: Dagliga nyheter -->
            <div class="perk-item">
                <div class="perk-icon">
                    <i class="fa-solid fa-face-smile"></i>
                </div>
                <div class="perk-text">
                    Nyheter varje dag
                </div>
            </div>
        </div>

        <!-- ACCORDION-SEKTION: Utfällbara menyer för mobil navigation -->
        <div class="accordions">
             <!-- Accordion 1: Shopping-kategorier -->
             <div class="accordion-wrapper">
                <button class="accordion">
                    Shopping
                </button>
                <div class="panel">
                    <p class="panel-item">Vinterjackor</p>
                    <p class="panel-item">Pufferjackor</p>
                    <p class="panel-item">Koppa</p>
                    <p class="panel-item">Trenchcoats</p>
                </div>
            </div>

            <!-- Accordion 2: Mina sidor-funktioner -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Mina sidor
                </button>
                <div class="panel">
                    <p class="panel-item">Mina Ordrar</p>
                    <p class="panel-item">Mitt konto</p>
                </div>
            </div>

            <!-- Accordion 3: Kundtjänst-alternativ -->
            <div class="accordion-wrapper">
                <button class="accordion">
                    Kundtjänst
                </button>
                <div class="panel">
                    <p class="panel-item">Kontakta oss</p>
                    <p class="panel-item">Hitta hit</p>
                </div>
            </div>
        </div>

        <!-- FOOTER-SEKTION: Enkel copyright-information -->
        <footer>
            &#169; FakeShop
        </footer>
    </div>
    
    <!-- JAVASCRIPT-SEKTION: All funktionalitet för kassasidan -->
     <script>
        // ====================================================================
        // ACCORDION-FUNKTIONALITET FÖR MOBIL NAVIGATION
        // ====================================================================
        
        // Hämta alla accordion-knappar från DOM:en
        var acc = document.getElementsByClassName("accordion");
        var i;

        // Loopa igenom alla accordion-knappar och lägg till click-lyssnare
        for (i = 0; i < acc.length; i++) {
             // Kontrollera om skärmen är mindre än 640px (mobil)
             if (window.matchMedia("(max-width: 639px)").matches) {
                 // Lägg till click-lyssnare för varje accordion-knapp
                 acc[i].addEventListener("click", function () {
                    // Växla "active"-klassen på den klickade knappen
                    this.classList.toggle("active");
                    
                    // Hitta nästa element (panelen som hör till knappen)
                    var panel = this.nextElementSibling;
                    
                    // Växla synlighet för panelen
                    if (panel.style.display === "block") {
                        panel.style.display = "none";  // Dölj panelen
                    } else {
                        panel.style.display = "block"; // Visa panelen
                    }
                });
            }
        }

        // ====================================================================
        // CHECKOUT-MANAGER KLASS: Hanterar hela kassafunktionaliteten
        // ====================================================================
        
        class CheckoutManager {
            /**
             * Konstruktor som initialiserar CheckoutManager
             * Laddar varukorgen från localStorage och startar initialiseringen
             */
            constructor() {
                // Ladda befintliga varukorgsartiklar från localStorage
                this.basketItems = this.loadBasket();
                console.log('🛒 CheckoutManager initialiserad, varukorg:', this.basketItems);
                
                // Starta initialiseringsprocessen
                this.init();
            }

            /**
             * Ladda varukorg från localStorage
             * @returns {Array} Array med varukorgsartiklar, tom array om inget finns
             */
            loadBasket() {
                // Försök hämta varukorg från localStorage
                const basket = localStorage.getItem('fakeShopBasket');
                
                // Om varukorg finns, parsea JSON-data, annars returnera tom array
                return basket ? JSON.parse(basket) : [];
            }

            /**
             * Räkna ut alla totaler för beställningen
             * @returns {Object} Objekt med subtotal, shipping och total
             */
            calculateTotals() {
                // Räkna ut delsumma genom att summera pris × antal för alla artiklar
                const subtotal = this.basketItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Beräkna fraktkostnad: Gratis över 500 SEK, 49 SEK annars (0 om tom korg)
                const shipping = subtotal > 500 ? 0 : (subtotal > 0 ? 49 : 0);
                
                // Beräkna totalsumma
                const total = subtotal + shipping;
                
                // Returnera alla beräknade värden
                return { subtotal, shipping, total };
            }

            /**
             * Rendera varukorgssummeringen i checkout-tabellen
             * Uppdaterar både artiklar och totaler
             */
            renderCheckoutSummary() {
                // Hämta referenser till tabellens body och foot
                const tableBody = document.querySelector('.cart-summary-table tbody');
                const tableFoot = document.querySelector('.cart-summary-table tfoot');

                // Kontrollera om varukorgen är tom
                if (this.basketItems.length === 0) {
                    // Visa meddelande om tom varukorg
                    tableBody.innerHTML = '<tr><td colspan="4">Din varukorg är tom</td></tr>';
                    tableFoot.innerHTML = '<tr><td colspan="3">TOTALT</td><td>0 SEK</td></tr>';
                    return; // Avsluta funktionen tidigt
                }

                // Rendera alla artiklar som tabellrader
                tableBody.innerHTML = this.basketItems.map(item => `
                    <tr>
                        <td data-label="Produkt:">${item.name}<br><small>${item.brand}</small></td>
                        <td data-label="Antal:">${item.quantity}</td>
                        <td data-label="Pris:">${item.price} SEK</td>
                        <td data-label="Totalt:">${item.price * item.quantity} SEK</td>
                    </tr>
                `).join('');

                // Beräkna och visa totaler
                const { subtotal, shipping, total } = this.calculateTotals();
                tableFoot.innerHTML = `
                    <tr>
                        <td colspan="3">Delsumma</td>
                        <td>${subtotal} SEK</td>
                    </tr>
                    <tr>
                        <td colspan="3">Frakt</td>
                        <td>${shipping === 0 ? 'Gratis' : shipping + ' SEK'}</td>
                    </tr>
                    <tr style="font-weight: bold;">
                        <td colspan="3">TOTALT</td>
                        <td>${total} SEK</td>
                    </tr>
                `;
            }

            /**
             * Hantera formulärinlämning för checkout-processen
             * @param {Event} event - Form submit event
             */
            async handleCheckout(event) {
                console.log('📨 Form submission fångad av JavaScript');
                
                // VIKTIGT: Förhindra webbläsarens standard form submission
                event.preventDefault();
                event.stopPropagation();
                
                // Kontrollera att varukorgen inte är tom
                if (this.basketItems.length === 0) {
                    alert('Din varukorg är tom!');
                    return;
                }

                // Hämta formulärdata
                const form = event.target;
                const formData = new FormData(form);
                
                // Hämta referenser till UI-element för loading state
                const btnText = document.getElementById('btn-text');
                const btnSpinner = document.getElementById('btn-spinner');
                const submitBtn = document.getElementById('purchase-btn');
                
                // Visa loading state: dölj text, visa spinner, inaktivera knapp
                btnText.style.display = 'none';
                btnSpinner.style.display = 'inline';
                submitBtn.disabled = true; // Förhindra flera klick
                
                try {
                    // Skapa orderdata-objekt från formulärdata och varukorgsartiklar
                    const orderData = {
                        // Kombinera för- och efternamn till fullständigt namn
                        customer_name: `${formData.get('fnamn')} ${formData.get('enamn')}`,
                        customer_email: formData.get('email'),
                        // Telefon är valfritt, använd tom sträng om inte ifyllt
                        customer_phone: formData.get('telefon') || '',
                        // Kombinera alla adressfält till en fullständig adress
                        shipping_address: `${formData.get('gata')}, ${formData.get('postnummer')} ${formData.get('stad')}`,
                        payment_method: 'card', // Standardbetalningsmetod
                        // Mappa varukorgsartiklar till orderformat
                        items: this.basketItems.map(item => ({
                            id: item.id,
                            name: item.name,
                            brand: item.brand,
                            quantity: item.quantity,
                            price: item.price
                        }))
                    };

                    // Logga orderdata för debugging
                    console.log('🔄 Skickar order:', orderData);
                    console.log('📊 Items detaljer:', JSON.stringify(orderData.items, null, 2));

                    // Skicka POST-request till API:et för att skapa ordern
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(orderData)
                    });

                    // Kontrollera om API-svaret är framgångsrikt
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // Parsea JSON-svaret från API:et
                    const result = await response.json();
                    console.log('✅ Order skapad:', result);

                    // Rensa varukorgen från localStorage eftersom ordern är skapad
                    localStorage.removeItem('fakeShopBasket');

                    // Omdirigera användaren till bekräftelsesidan med order-ID
                    window.location.href = `/order-confirmation.html?order=${result.order_id}`;

                } catch (error) {
                    // Hantera fel som kan uppstå under checkout-processen
                    console.error('❌ Fel vid checkout:', error);
                    alert('Ett fel uppstod vid beställningen. Försök igen.');
                    
                    // Återställ knappens tillstånd så användaren kan försöka igen
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                    submitBtn.disabled = false;
                }
            }

            /**
             * Initiera CheckoutManager genom att rendera UI och lägga till event listeners
             */
            init() {
                console.log('🔧 Initialiserar CheckoutManager...');
                
                // Rendera den aktuella varukorgens innehåll
                this.renderCheckoutSummary();
                
                // Hitta checkout-formuläret och lägg till submit-lyssnare
                const form = document.getElementById('checkout-form');
                if (form) {
                    console.log('✅ Form hittad, lägger till event listener');
                    // Binda handleCheckout-metoden till form submit event
                    form.addEventListener('submit', (e) => this.handleCheckout(e));
                    
                    // Extra säkerhet - lyssna även på submit-knappen direkt
                    const submitBtn = document.getElementById('purchase-btn');
                    if (submitBtn) {
                        submitBtn.addEventListener('click', (e) => {
                            console.log('🖱️ Submit-knapp klickad');
                            // Låt den normala form submission hantera detta
                        });
                    }
                } else {
                    // Felsökning: logga om formuläret inte hittas
                    console.error('❌ Kunde inte hitta checkout-form!');
                }
            }
        }

        // ====================================================================
        // HUVUDINITIALISERING: Startar allt när DOM:en är laddad
        // ====================================================================
        
        // Vänta tills hela DOM:en är laddad innan vi startar JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM laddad, startar CheckoutManager');
            
            // ================================================================
            // UTVECKLINGS-/FELSÖKNINGSSEKTION: Rensa och lägg till testdata
            // ================================================================
            
            console.log('🧹 Rensar befintlig varukorg för felsökning...');
            // Rensa befintlig varukorg för konsistent testning
            localStorage.removeItem('fakeShopBasket');
            
            console.log('🛒 Lägger till nya testprodukter...');
            // Skapa testartiklar för att demonstrera funktionaliteten
            const testItems = [
                {
                    id: 36,                              // Unikt produkt-ID
                    name: "Premium Kappa",               // Produktnamn
                    brand: "Calvin Klein",               // Märke
                    price: 1299,                         // Pris i SEK
                    quantity: 1,                         // Antal i varukorgen
                    image_url: "/images/product.png"     // Produktbild (används inte i checkout)
                },
                {
                    id: 5,                               // Unikt produkt-ID för andra produkten
                    name: "Hot Tröja",                   // Produktnamn
                    brand: "Tommy Hilfiger",             // Märke
                    price: 549,                          // Pris i SEK
                    quantity: 2,                         // Antal i varukorgen
                    image_url: "/images/product.png"     // Produktbild
                }
            ];
            
            // Spara testartiklarna i localStorage
            localStorage.setItem('fakeShopBasket', JSON.stringify(testItems));
            console.log('✅ Testprodukter tillagda:', testItems);
            
            // Skapa och starta CheckoutManager med testdata
            new CheckoutManager();
        });
    </script>
</body>
</html>